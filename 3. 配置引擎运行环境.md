配置引擎运行环境 { .text-center }
--------------

&nbsp;

### 指定机器人的温度与上下文深度

chatGPT 的温度参数（temperature）用来控制 AI 应答的发散程度，在 0 至 2 之间取值 0 到 2 这间取值，取值越低，AI 回答越倾向于高概率答案，即，回答越确定，取值越高，越不确定，甚至胡言乱语，但更具创造性。

chatGPT 还是边聊边忘的机器人，你提供给它的上文信息越多，它的表现更像真人，能做到前后句上下文连贯，但传递给它的历史记录总数有上限，否则与它聊天成本很高，输入 token 比输出 token 稍稍便宜。我们把每次提交问题时，附带传给 AI 的最近问答次数叫上下文深度（context_size），填密语公众号建议的平均取值是 5，即，让机器人记忆最近的 5 问 5 答。

如果当前问话不依赖历史记录，我们不妨将上下文深度设为 0，即，不再向 chatGPT 提交历史沟通信息，这样能大幅节约聊天成本 。

我们继续优化上面的例子，增加运行环境的若干配置项。

``` json
{
  "room_ver": 1,
  "room_name": "旅游服务",
  
  "system_role": "你是一个友善的导游",
  "context_size": 1,
  "temperature": 0.7,
  "max_tokens": 600,
  
  "magic_rules": {
    "介绍":[["景点名","replace","{where}"], "*"]
  },
  "prompts": {
    "介绍":{ "ask":"我提供一个景点名称，你将介绍该景点的特色、人文背景、历史典故，简短些。请介绍景点：{where} 。",
      "context_size":3, "temperature":0
    }
  },
  "hint_magics": ["介绍"]
}
```

我们可以看到，room 定义的 context_size 与 temperature 缺省值分别是 `1` 与 `0.7`，缺省值还可以被 prompts 中某具体触发词的 prompt 定义覆盖，本例 `"介绍"` 触发词的 prompt 定义用 3 与 0 值分别替代 context_size 与 temperature 缺省值。

max_tokens 配置项指示本 room 一次回答限用 600 tokens（注：是 AI 生成问题答案的消耗，未含输入 prompt 的消耗），如果超出此限制 chatGPT 会截断返回的文本。

补充说明，上面我们还为 `"介绍"` 触发词增加第二个参数  `*`，星号表示匹配余下的所有输入文本，这些文本将自动添加到对应 prompt 的尾部。比如，用户输入 `"介绍 广东梁启超故居 从深圳出发怎么坐车？"`，最终获得的输入是：“我提供一个景点名称，你将介绍该景点的特色、人文背景、历史典故，简短些。请介绍景点：广东梁启超故居。从深圳出发怎么坐车？” 。

&nbsp;

### 给 room 设置全局变量

现在我们增加第二个触发词 `"特产"`，让 AI 介绍景点有什么特产，但希望不要再输一次景点名称。

先把 room 定义优化成如下样子（增加了 `"特产"` 触发词的相关定义）：

``` json
{
  "room_ver": 1,
  "room_name": "旅游服务",
  
  "system_role": "你是一个友善的导游",
  "context_size": 1,
  "temperature": 0.7,
  "max_tokens": 600,
  
  "globals": {"where":"北京故宫"},
  "magic_rules": {
    "介绍":[["景点名","replace","{where}"], "*"],
    "特产":["*"]
  },
  "prompts": {
    "介绍":{ "ask":"我提供一个景点名称，你将介绍该景点的特色、人文背景、历史典故，简短些。请介绍景点：{where} 。",
      "context_size":3, "temperature":0
    },
    "特产":{ "ask":"请问 {where} 景点有什么特产？", "context_size":5, "temperature":0}
  },
  "hint_magics": ["介绍","特产"]
  "state_desc": "({where})"
}
```

前面我们已介绍局部变量 `{where}`，现在把该 local 变量改成 global 全局变量，便于让同一 room 中由不同触发词生成的 prompt 都能引用这变量，变量赋值后可被多次引用。只需将 `"{where}"` 定义纳入 globals 配置项，这个原先 local 变量就转成 global 的了 。

当全局变量被修改（比如输入 `"介绍 香港迪斯尼乐园"`，where 变量就改了）时，公众号后台服务器会自动保存修改后的值，但对局部变量则不保存。凡引用的变量未在 room 的 globals 列表申明的，都是局部变量（除了系统内置还有若干变量，后文还会讲到）。局部变量只在一次触发词的触发过程中有效，当次一问一答结束 local 变量随即失效。

用户输入 `"?"` 查询时，宜在打印帮助信息指示全局变量当前取值。我们只需在 state_desc 配置项引用相关变量。在这个例子中，输入 `"？"` 后的打印信息如下：

```
当前房间：旅游服务(广东梁启超故居)

当前指令：
  介绍 景点名 *
  特产 *
```

前面我们已介绍字串类型的变量，对它赋值要用 replace 指令。除了 str 类型，对 global 变量做 replace 赋值还支持 `bool, int, float` 类型，global 变量原值类型决定了赋值后它也维持相同数据类型。如果被 replace 变量的数据类型不是 `bool, int, float, str` 这四者之一，replace 操作将被忽略。

用 replace 指令对 local 变量的赋值（即，被赋值变量在 room 的 globals 中未定义，自动视为 local 变量），则始终以 str 类型值进行替换或赋新值。
