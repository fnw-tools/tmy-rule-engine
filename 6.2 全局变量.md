全局变量 { .text-center }
-------

&nbsp;

### 规则引擎 VM 的生命周期

填密语公众号中的规则引擎 VM 与聊天室相关联，一间聊天室对应一个 VM，但只有当前活跃的聊天室（即，当下接受输入及输出的那一间聊天室）才有 VM 实例与之对应。如果用户切换聊天室，原 VM 将自动销毁，系统将另建一个 VM 供新切换进来的聊天室使用。

总结一下，规则引擎虚拟机为当前聊天室提供运行环境，它随聊天室开启而开启，也随聊天室关闭而关闭。

&nbsp;

### 聊天室定义与 VM 全局变量之间的关系

一间聊天室刚开启时，系统将依据 room 定义（下面记为 `room_cfg`）初始化 VM 的全局变量空间。

 - 第一步，系统依据 `room_cfg.globals` 定义，初始化 VM 全局变量  
   比如 `room_cfg.globals` 定义了 `{"where":"北京故宫"}`，初始化 VM 全局变量为 `{"where":"北京故宫"}`。
 - 第二步，系统依据上次使用该聊天室时对全局变量所作的修改，更新 VM 中相关全局变量的值
 - 第三步，系统依据 `room_cfg.context_size, room_cfg.temperature, room_cfg.max_tokens` 定义，自动更新 VM 中同名全局变量的值。  
   如果 context_size 在 room_cfg 中未定义就自动取值 1，如果 temperature 未定义自动取 0.7，如果 max_tokens 未定义自动取 600。

可见，聊天室 room 定义决定了 VM 全局变量初始取值，其中 `context_size, temperature, max_tokens` 这 3 个变量还从 room 定义中平移过来。

&nbsp;

### 全局变量的类型

VM 中全局变量类型由其初值决定，比如 `room_cfg.globals` 定义了 `{"where":"北京故宫","year":2023}`，全局变量 where 就确定为 str 类型，year 确定为 int 类型，全局变量的类型一经确定，在它的生命周期内将不可被改变。

经触发词传递的变量可以给全局变量赋值，但限于对 "bool, int, float, string, set" 这几种类型的全局变量进行修改。

&nbsp;

### 由触发词驱动全局变量修改

我们在 `room_cfg.magic_rules` 定义的某个触发词规则时，可以指定某个全局变量可被修改。遵循如下规则：

&nbsp;

**规则1：对 "bool, int, float, string" 类型的全局变量，用 "replace" 指令实现赋值**

比如，`{"介绍":[["景点名","replace","{where}"]]}` 表示将 `"介绍"` 触发词的 `"景点名"` 参数值赋给 where 变量。"replace" 指令的含义是对变量取值进行整体替换。

对多个参数对应的变量进行赋值，可以类推，比如 `{"介绍":[["城市名","replace","{city}"],["景点名","replace","{where}"]]}`，对 city 与 where 两个变量进行赋值。

如果传入参数的类型与全局变量类型不匹配，系统会自动转化。

&nbsp;

**规则2：用 `include, exclude, clear` 指令修改 "list, set" 类型的变量**

list 与 set 属于复合类型，比如 `room_cfg.globals` 定义全局变量 `{"good_habits":["keep_clean","healthy_diet"]}`，这里 good_habits 是 list 类型的变量，它的 include 操作是添加项目，exclude 操作是移除项目，clear 是清除所有项目。

比如这么定义 `room_cfg.magic_rules`：

```
{
  "包含": [
    [ "生活方式", "include", "{good_habits}"]
  ],
  "移除": [
    [ "生活方式", "exclude", "{good_habits}"]
  ]
}
```

相应触发词触发动作后，`"生活方式"` 的参数值将分别被包含到或移除出 good_habits 变量。

&nbsp;

**规则3：将触发词自身视作 str 类型数据对变量赋值**

按如下方式定义 `room_cfg.magic_rules`：

```
{
  "省钱模式":"{type}",
  "费钱模式":"{type}"
}
```

当 magic_rules 中定义某项触发词不再是以 list 类型数据表达的参数列表，而改用 str 指示被赋值的变量（如上面代码 `"{type}"`）时，系统将自动把触发词自身的字串值赋给指定的变量。在这个例子中，用户输入 `"省钱模式"` 触发的结果是，变量 `"type"` 被赋值为 `"省钱模式"`。

&nbsp;
